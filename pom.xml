<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0
                             http://maven.apache.org/xsd/maven-4.0.0.xsd">

  <modelVersion>4.0.0</modelVersion>

  <groupId>pt.isep</groupId>
  <artifactId>bookmarkscc</artifactId>
  <version>1.0.0</version>
  <packaging>jar</packaging>

  <!-- ===================== PROPERTIES ===================== -->
  <properties>
    <maven.compiler.release>21</maven.compiler.release>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <javafx.version>21.0.4</javafx.version>

    <!-- PTEID -->
    <pteid.jar>/usr/local/lib/pteid_jni/pteidlibj.jar</pteid.jar>
    <pteid.lib.path>/usr/local/lib:/usr/local/lib/pteid_jni</pteid.lib.path>

    <app.name>BookmarksCC</app.name>
    <app.vendor>ISEP</app.vendor>

    <app.install.dir>/opt/bookmarkscc</app.install.dir>
    <linux.menu.group>Utility</linux.menu.group>
    <linux.package.name>bookmarkscc</linux.package.name>
    <linux.deps>pcscd,libpcsclite1</linux.deps>
  </properties>

  <!-- ===================== DEPENDENCIES ===================== -->
  <dependencies>
    <dependency>
      <groupId>org.openjfx</groupId>
      <artifactId>javafx-controls</artifactId>
      <version>${javafx.version}</version>
    </dependency>

    <dependency>
      <groupId>org.openjfx</groupId>
      <artifactId>javafx-fxml</artifactId>
      <version>${javafx.version}</version>
    </dependency>

    <dependency>
      <groupId>org.xerial</groupId>
      <artifactId>sqlite-jdbc</artifactId>
      <version>3.46.1.0</version>
    </dependency>

    <dependency>
      <groupId>org.bouncycastle</groupId>
      <artifactId>bcprov-jdk18on</artifactId>
      <version>1.78.1</version>
    </dependency>

    <dependency>
      <groupId>org.slf4j</groupId>
      <artifactId>slf4j-simple</artifactId>
      <version>2.0.13</version>
    </dependency>

    <!-- PTEID Java SDK (system) -->
    <dependency>
      <groupId>pt.gov</groupId>
      <artifactId>pteidlibj</artifactId>
      <version>local</version>
      <scope>system</scope>
      <systemPath>${pteid.jar}</systemPath>
    </dependency>
  </dependencies>

  <!-- ===================== BUILD ===================== -->
  <build>
    <plugins>

      <!-- Compiler -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.13.0</version>
        <configuration>
          <release>${maven.compiler.release}</release>
        </configuration>
      </plugin>

      <!-- JavaFX run (DEV) -->
      <plugin>
        <groupId>org.openjfx</groupId>
        <artifactId>javafx-maven-plugin</artifactId>
        <version>0.0.8</version>
        <configuration>
          <mainClass>pt.isep.bookmarkscc.App</mainClass>
          <jvmArgs>
            <jvmArg>-Djava.library.path=${pteid.lib.path}</jvmArg>
          </jvmArgs>
        </configuration>
      </plugin>

      <!-- SHADE (UBER-JAR) -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-shade-plugin</artifactId>
        <version>3.6.0</version>
        <executions>
          <execution>
            <phase>package</phase>
            <goals>
              <goal>shade</goal>
            </goals>
            <configuration>

              <!-- CRÃTICO: remover assinaturas para evitar SecurityException -->
              <filters>
                <filter>
                  <artifact>*:*</artifact>
                  <excludes>
                    <exclude>META-INF/*.SF</exclude>
                    <exclude>META-INF/*.DSA</exclude>
                    <exclude>META-INF/*.RSA</exclude>
                  </excludes>
                </filter>
              </filters>

              <transformers>
                <transformer implementation="org.apache.maven.plugins.shade.resource.ManifestResourceTransformer">
                  <mainClass>pt.isep.bookmarkscc.App</mainClass>
                </transformer>
              </transformers>

              <finalName>${project.artifactId}-${project.version}-all</finalName>
              <shadedArtifactAttached>false</shadedArtifactAttached>
            </configuration>
          </execution>
        </executions>
      </plugin>

      <!-- Exec plugin (DIST) -->
      <plugin>
        <groupId>org.codehaus.mojo</groupId>
        <artifactId>exec-maven-plugin</artifactId>
        <version>3.4.1</version>
      </plugin>

    </plugins>
  </build>

  <!-- ===================== DIST PROFILE ===================== -->
  <profiles>
    <profile>
      <id>dist</id>
      <build>
        <plugins>

          <plugin>
            <groupId>org.codehaus.mojo</groupId>
            <artifactId>exec-maven-plugin</artifactId>
            <executions>

              <!-- criar target/app -->
              <execution>
                <id>mk-app-dir</id>
                <phase>package</phase>
                <goals><goal>exec</goal></goals>
                <configuration>
                  <executable>bash</executable>
                  <arguments>
                    <argument>-lc</argument>
                    <argument>mkdir -p "${project.build.directory}/app"</argument>
                  </arguments>
                </configuration>
              </execution>

              <!-- copiar uber-jar -->
              <execution>
                <id>copy-main-jar</id>
                <phase>package</phase>
                <goals><goal>exec</goal></goals>
                <configuration>
                  <executable>bash</executable>
                  <arguments>
                    <argument>-lc</argument>
                    <argument>
                      cp "${project.build.directory}/${project.artifactId}-${project.version}-all.jar" \
                         "${project.build.directory}/app/${project.artifactId}-${project.version}-all.jar"
                    </argument>
                  </arguments>
                </configuration>
              </execution>

              <!-- copiar JavaFX jars para dentro do input do jpackage -->
              <execution>
                <id>copy-javafx-jars</id>
                <phase>package</phase>
                <goals><goal>exec</goal></goals>
                <configuration>
                  <executable>bash</executable>
                  <arguments>
                    <argument>-lc</argument>
                    <argument>
                      mkdir -p "${project.build.directory}/app/javafx" &amp;&amp;
                      cp "$HOME/.m2/repository/org/openjfx/javafx-base/${javafx.version}/javafx-base-${javafx.version}-linux.jar" "${project.build.directory}/app/javafx/" &amp;&amp;
                      cp "$HOME/.m2/repository/org/openjfx/javafx-graphics/${javafx.version}/javafx-graphics-${javafx.version}-linux.jar" "${project.build.directory}/app/javafx/" &amp;&amp;
                      cp "$HOME/.m2/repository/org/openjfx/javafx-controls/${javafx.version}/javafx-controls-${javafx.version}-linux.jar" "${project.build.directory}/app/javafx/" &amp;&amp;
                      cp "$HOME/.m2/repository/org/openjfx/javafx-fxml/${javafx.version}/javafx-fxml-${javafx.version}-linux.jar" "${project.build.directory}/app/javafx/"
                    </argument>
                  </arguments>
                </configuration>
              </execution>

              <!-- NOVO: copiar pteidlibj.jar para dentro do input do jpackage -->
              <execution>
                <id>copy-pteid-jar</id>
                <phase>package</phase>
                <goals><goal>exec</goal></goals>
                <configuration>
                  <executable>bash</executable>
                  <arguments>
                    <argument>-lc</argument>
                    <argument>
                      cp "${pteid.jar}" "${project.build.directory}/app/pteidlibj.jar"
                    </argument>
                  </arguments>
                </configuration>
              </execution>

              <!-- jpackage -->
              <execution>
                <id>jpackage-deb</id>
                <phase>package</phase>
                <goals><goal>exec</goal></goals>
                <configuration>
                  <executable>jpackage</executable>
                  <arguments>

                    <argument>--type</argument>
                    <argument>deb</argument>

                    <argument>--name</argument>
                    <argument>${app.name}</argument>

                    <argument>--app-version</argument>
                    <argument>${project.version}</argument>

                    <argument>--vendor</argument>
                    <argument>${app.vendor}</argument>

                    <argument>--input</argument>
                    <argument>${project.build.directory}/app</argument>

                    <argument>--main-jar</argument>
                    <argument>${project.artifactId}-${project.version}-all.jar</argument>

                    <argument>--main-class</argument>
                    <argument>pt.isep.bookmarkscc.App</argument>

                    <argument>--install-dir</argument>
                    <argument>${app.install.dir}</argument>

                    <argument>--linux-package-name</argument>
                    <argument>${linux.package.name}</argument>

                    <argument>--linux-shortcut</argument>

                    <argument>--linux-menu-group</argument>
                    <argument>${linux.menu.group}</argument>

                    <argument>--linux-package-deps</argument>
                    <argument>${linux.deps}</argument>

                    <!-- PTEID native libs -->
                    <argument>--java-options</argument>
                    <argument>-Djava.library.path=${pteid.lib.path}</argument>

                    <!-- JavaFX -->
                    <argument>--java-options</argument>
                    <argument>--module-path=$APPDIR/javafx</argument>

                    <argument>--java-options</argument>
                    <argument>--add-modules=javafx.controls,javafx.fxml</argument>

                    <!-- postinst / prerm -->
                    <argument>--resource-dir</argument>
                    <argument>${project.basedir}/src/main/jpackage</argument>

                    <argument>--dest</argument>
                    <argument>${project.build.directory}/dist</argument>

                  </arguments>
                </configuration>
              </execution>

            </executions>
          </plugin>

        </plugins>
      </build>
    </profile>
  </profiles>

</project>
